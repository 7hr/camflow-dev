version: 2.1
jobs:
  checkout:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - restore_cache:
         keys:
           - build-{{ checksum "Makefile" }}
      - run:
          name: 'Prepare build environment...'
          command: |
            if [ -d "build/linux-stable" ]; then
              echo 'Build environment was cached.'
            else
              echo 'Build environment was not cached.'
              apt-get update -qq
              apt-get install -y sudo
              apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev
              make prepare_kernel
              make save_space
            fi
      - save_cache:
          key: build-{{ checksum "Makefile" }}
          paths:
            - build
      - persist_to_workspace:
          root: .
          paths: build

  doc:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'cd ./scripts && make prepare'
      - run: 'cd ./scripts && make config'
      - run:
          command: 'cd ./scripts && make compile'
          no_output_timeout: '30m'
      - run: 'cd ./scripts && make run'
      - run: 'cd ./scripts && cat syslist.txt'
      - run: 'make doc'
      - persist_to_workspace:
          root: .
          paths:
            - docs
            - scripts
  security:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'make compile_security_only'
  compile_default:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'make compile_kernel'
  compile_no_flow_friendly:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_SECURITY_FLOW_FRIENDLY=y/CONFIG_SECURITY_FLOW_FRIENDLY=n/" .config'
      - run: 'make compile_kernel'
  compile_whole:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/# CONFIG_SECURITY_PROVENANCE_WHOLE_SYSTEM is not set/CONFIG_SECURITY_PROVENANCE_WHOLE_SYSTEM=y/" .config'
      - run: 'make compile_kernel'
  compile_persist:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/# CONFIG_SECURITY_PROVENANCE_PERSISTENCE is not set/CONFIG_SECURITY_PROVENANCE_PERSISTENCE=y/" .config'
      - run: 'make compile_kernel'
  sparse:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'cd build && git clone git://git.kernel.org/pub/scm/devel/sparse/sparse.git'
      - run: 'cd build/sparse && make'
      - run: 'cd build/sparse && make install'
      - run: 'cp -f /root/bin/sparse /bin/sparse'
      - run: 'cp -f /root/bin/cgcc /bin/cgcc'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'mkdir -p test'
      - run: 'cd ./build/linux-stable && make C=2 security/provenance/ &>  ~/circulate/test/sparse.txt || true'
      - run: 'cat ./test/sparse.txt'
      - persist_to_workspace:
          root: .
          paths:
            - test/sparse.txt
  flawfinder:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install -y flawfinder'
      - run: 'apt-get install --reinstall make'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'mkdir -p test'
      - run: 'cd ./build/linux-stable && flawfinder ./security/provenance > ~/circulate/test/flawfinder.txt'
      - run: 'cat ./test/flawfinder.txt'
      - persist_to_workspace:
          root: .
          paths:
            - test/flawfinder.txt
  checkpatch:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'mkdir -p test'
      - run: 'cd ./build/linux-stable && ./scripts/checkpatch.pl --show-types --file security/provenance/*.c > ~/circulate/test/checkpatch.txt || true'
      - run: 'cd ./build/linux-stable && ./scripts/checkpatch.pl --show-types --file security/provenance/include/*.h > ~/circulate/test/headers_checkpatch.txt || true'
      - run: 'cat ./test/checkpatch.txt'
      - run: 'cat ./test/headers_checkpatch.txt'
      - persist_to_workspace:
          root: .
          paths:
            - test/checkpatch.txt
            - test/headers_checkpatch.txt
  smatch:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install --reinstall make'
      - run: 'make prepare_smatch'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'mkdir -p test'
      - run: 'cd ./build/linux-stable && make clean'
      - run: 'cd ./build/linux-stable && make security CHECK="../smatch/smatch -p=kernel" C=1 >  ~/circulate/test/smatch.txt'
      - run: 'cat ./test/smatch.txt'
      - persist_to_workspace:
          root: .
          paths:
            - test/smatch.txt
  coccinelle:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y uncrustify rsync build-essential ruby python autoconf automake libtool libncurses5-dev libncursesw5-dev bc libssl-dev pkg-config zsh libelf-dev bison flex sqlite3 libsqlite3-dev'
      - run: 'apt-get install -y ocaml-native-compilers ocaml-findlib menhir libmenhir-ocaml-dev libpcre-ocaml-dev libparmap-ocaml-dev texlive-fonts-extra'
      - run: 'apt-get install --reinstall make'
      - run: 'apt-get build-dep -y coccinelle'
      - run: 'cd build && git clone https://github.com/coccinelle/coccinelle.git'
      - run: 'cd build && git checkout 1.0.8'
      - run: 'cd build/coccinelle && make clean'
      - run: 'cd build/coccinelle && ./autogen'
      - run: 'cd build/coccinelle && ./configure'
      - run: 'cd build/coccinelle && make'
      - run: 'cd build/coccinelle && make install'
      - run: 'cp -f scripts/.config build/linux-stable/'
      - run: 'make config_circle'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_CC_STACKPROTECTOR_STRONG=y/CONFIG_CC_STACKPROTECTOR_STRONG=n/" .config'
      - run: 'cd build/linux-stable && sed -i "s/CONFIG_RETPOLINE=y/CONFIG_RETPOLINE=n/" .config'
      - run: 'mkdir -p test'
      - run: 'cd ./build/linux-stable && sed -i "/options = --use-gitgrep/d" .cocciconfig'
      - run: 'cd ./build/linux-stable && make coccicheck MODE=report M=security/provenance > ~/circulate/test/cocci.txt || true'
      - run: 'cat ./test/cocci.txt'
      - persist_to_workspace:
          root: .
          paths:
            - test/cocci.txt
  deploy_dev:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - attach_workspace:
          at: ~/circulate
      - run: 'apt-get update -qq'
      - run: 'apt-get install -y sudo'
      - run: 'apt-get install -y git rsync'
      - run: 'apt-get install -y ruby'
      - run: 'ruby ./scripts/clean_test.rb'
      - run: 'cd test && ls'
      - deploy:
          name: Deploy
          command: |
            git config --global user.email $GH_EMAIL
            git config --global user.name $GH_NAME
            git status
            ls -l ./docs/img
            ls -l ./docs/dot
            mkdir -p output
            cd output
            echo "Cloning..."
            git clone https://github.com/camflow/camflow-dev
            cd camflow-dev
            git checkout dev
            echo "Copying..."
            mkdir -p docs
            mkdir -p scripts
            mkdir -p test
            rsync -r ../../docs/ ./docs
            rsync -r ../../scripts/ ./scripts
            rsync -r ../../test/ ./test
            echo "Check files are there"
            ls -l ./docs/img
            ls -l ./docs/dot
            git status
            git add .
            git status
            # is there any change
            if ! git diff-index --exit-code --quiet HEAD; then
              echo 'Committing...'
              git commit -a -m "[ci skip] CircleCI automated documentation generation and testing, based on commit ${CIRCLE_SHA1}"
              git push -q https://${GH_TOKEN}@github.com/camflow/camflow-dev.git dev
            else
              echo 'Nothing to commit.'
            fi
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - checkout
      - security:
          requires:
            - checkout
      - compile_default:
          requires:
            - security
      - compile_no_flow_friendly:
          requires:
            - security
      - compile_whole:
          requires:
            - security
      - compile_persist:
          requires:
            - security
      - doc:
          requires:
            - compile_default
            - compile_no_flow_friendly
            - compile_whole
            - compile_persist
      - sparse:
          requires:
            - compile_default
            - compile_no_flow_friendly
            - compile_whole
            - compile_persist
      - flawfinder:
          requires:
            - compile_default
            - compile_no_flow_friendly
            - compile_whole
            - compile_persist
      - checkpatch:
          requires:
            - compile_default
            - compile_no_flow_friendly
            - compile_whole
            - compile_persist
      - smatch:
          requires:
            - compile_default
            - compile_no_flow_friendly
            - compile_whole
            - compile_persist
      - coccinelle:
          requires:
            - compile_default
            - compile_no_flow_friendly
            - compile_whole
            - compile_persist
      - deploy_dev:
          filters:
            branches:
              only:
                - dev
          requires:
            - doc
            - sparse
            - flawfinder
            - checkpatch
            - smatch
            - coccinelle
